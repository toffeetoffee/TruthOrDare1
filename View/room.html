{% extends "base.html" %}
{% block title %}Room {{ room_code }} — Dare or Dare{% endblock %}

{% block topbar %}
  <span class="badge text-bg-secondary">Room: <span class="fw-semibold" id="roomCodeBadge">{{ room_code }}</span></span>
  <button class="btn btn-outline-danger btn-sm" id="btnLeave"><i class="bi bi-door-open me-1"></i>Leave</button>
  <button class="btn btn-outline-dark btn-sm" id="btnDestroy" title="Host only"><i class="bi bi-trash3 me-1"></i>Destroy</button>
  <button class="btn btn-primary btn-sm" id="btnSettings"><i class="bi bi-gear me-1"></i>Settings</button>
{% endblock %}

{% block content %}
<input type="hidden" id="roomCode" value="{{ room_code }}">
<input type="hidden" id="playerName" value="{{ name }}">

<!-- Lobby / Players -->
<section id="lobby-section" class="mb-4">
  <div class="row g-4">
    <div class="col-12 col-lg-6">
      <div class="card h-100 shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
          <div class="fw-semibold"><i class="bi bi-people me-1"></i>Players</div>
          <span class="badge text-bg-info"><span id="player-count">0</span></span>
        </div>
        <div class="card-body">
          <ul class="list-group list-group-flush" id="player-list">
            <li class="list-group-item text-secondary">Waiting for players…</li>
          </ul>
        </div>
      </div>
    </div>
    <div class="col-12 col-lg-6">
      <div class="card h-100 shadow-sm">
        <div class="card-header"><i class="bi bi-joystick me-1"></i>Host Controls</div>
        <div class="card-body" id="host-controls">
          <div class="d-grid gap-2">
            <button class="btn btn-success" id="btnStart"><i class="bi bi-play-fill me-1"></i>Start Game</button>
            <button class="btn btn-warning" id="btnRestart"><i class="bi bi-arrow-repeat me-1"></i>Restart Game</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Game Area -->
<section id="game-area" class="d-none">
  <!-- Round header -->
  <div class="d-flex align-items-center justify-content-between mb-3">
    <div class="h5 mb-0">Round <span id="round-number">1</span></div>
    <div class="d-flex align-items-center gap-3">
      <div class="text-secondary small">Phase: <span id="phase-label" class="fw-semibold">lobby</span></div>
      <div class="badge text-bg-primary"><i class="bi bi-hourglass-split me-1"></i><span id="timer">0</span>s</div>
    </div>
  </div>

  <!-- Sections -->
  <div id="countdown-section" class="card mb-3 d-none">
    <div class="card-body">Get ready…</div>
  </div>

  <div id="preparation-section" class="card mb-3 d-none">
    <div class="card-body">
      <h5 class="card-title">Preparation</h5>
      <p class="text-secondary mb-3">Add up to 3 items and choose target players.</p>
      <form id="submission-form" class="row g-2 align-items-end">
        <div class="col-md-8">
          <label class="form-label">Text</label>
          <input id="truth-dare-text" class="form-control" maxlength="200" placeholder="Type a truth or a dare">
        </div>
        <div class="col-md-4">
          <label class="form-label">Type</label>
          <select id="truth-dare-type" class="form-select">
            <option value="truth" selected>Truth</option>
            <option value="dare">Dare</option>
          </select>
        </div>
        <div class="col-12">
          <label class="form-label">Targets</label>
          <div id="player-checkboxes" class="d-flex flex-wrap gap-2"></div>
        </div>
        <div class="col-12 d-grid d-md-flex gap-2">
          <button class="btn btn-primary" type="submit"><i class="bi bi-send me-1"></i>Submit</button>
          <div id="submission-success" class="text-success small d-none"></div>
        </div>
      </form>
    </div>
  </div>

  <div id="selection-section" class="card mb-3 d-none">
    <div class="card-body d-flex align-items-center justify-content-between">
      <div>
        <h5 class="card-title mb-1">Selecting Player…</h5>
        <div class="text-secondary small">Fair randomization or minigame winner.</div>
      </div>
      <div>
        <button class="btn btn-outline-primary me-2" data-choice="truth" id="btnTruth"><i class="bi bi-chat-quote me-1"></i>Truth</button>
        <button class="btn btn-outline-danger" data-choice="dare" id="btnDare"><i class="bi bi-lightning me-1"></i>Dare</button>
      </div>
    </div>
  </div>

  <div id="minigame-section" class="card mb-3 d-none">
    <div class="card-body">
      <div class="d-flex align-items-center justify-content-between">
        <div>
          <h5 class="minigame-title mb-1">Mini Game</h5>
          <div class="minigame-description text-secondary small"></div>
        </div>
        <div class="text-nowrap">
          <span class="badge text-bg-secondary me-2">Votes A: <span id="vote-count-a">0</span></span>
          <span class="badge text-bg-secondary">Votes B: <span id="vote-count-b">0</span></span>
        </div>
      </div>
      <hr>
      <div class="row g-3">
        <div class="col-12 col-md-6">
          <div class="p-3 border rounded-3 text-center">
            <div class="fw-semibold mb-2" id="participant-1">Player 1</div>
            <button class="btn btn-outline-primary w-100 vote-btn" data-target="A">Vote A</button>
          </div>
        </div>
        <div class="col-12 col-md-6">
          <div class="p-3 border rounded-3 text-center">
            <div class="fw-semibold mb-2" id="participant-2">Player 2</div>
            <button class="btn btn-outline-primary w-100 vote-btn" data-target="B">Vote B</button>
          </div>
        </div>
      </div>
      <div class="text-secondary small mt-2 voting-instruction">Vote for the loser!</div>
    </div>
  </div>

  <div id="truth-dare-section" class="card mb-3 d-none">
    <div class="card-body d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-2">
      <div>
        <div class="h5 mb-0">Now performing: <span class="fw-semibold" id="selected-player">—</span></div>
        <div class="text-secondary"><span id="current-item-type">truth</span> • <span id="current-item-text">—</span></div>
      </div>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-secondary" id="btnVoteSkip"><i class="bi bi-skip-forward me-1"></i>Vote Skip</button>
      </div>
    </div>
  </div>

  <div id="end-game-section" class="card mb-3 d-none">
    <div class="card-body">
      <div class="d-flex align-items-center justify-content-between mb-2">
        <h5 class="card-title mb-0">Game Over</h5>
        <button class="btn btn-outline-warning" id="btnRestartAtEnd"><i class="bi bi-arrow-repeat me-1"></i>Restart</button>
      </div>
      <div class="row g-3">
        <div class="col-12 col-lg-6">
          <div class="border rounded-3 p-3">
            <div class="fw-semibold mb-2">Top Players</div>
            <ol id="top-players" class="mb-0"></ol>
          </div>
        </div>
        <div class="col-12 col-lg-6">
          <div class="border rounded-3 p-3">
            <div class="fw-semibold mb-2">Round History</div>
            <div id="round-history" class="small"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Settings Modal -->
<div class="modal fade" id="settingsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-gear me-1"></i>Game Settings</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row g-3">
          <div class="col-6 col-md-4">
            <label class="form-label">Countdown (3–30s)</label>
            <input id="setting-countdown" type="number" class="form-control" min="3" max="30" value="10">
          </div>
          <div class="col-6 col-md-4">
            <label class="form-label">Preparation (10–120s)</label>
            <input id="setting-preparation" type="number" class="form-control" min="10" max="120" value="30">
          </div>
          <div class="col-6 col-md-4">
            <label class="form-label">Selection (5–30s)</label>
            <input id="setting-selection" type="number" class="form-control" min="5" max="30" value="10">
          </div>
          <div class="col-6 col-md-4">
            <label class="form-label">Truth/Dare (30–180s)</label>
            <input id="setting-truthdare" type="number" class="form-control" min="30" max="180" value="60">
          </div>
          <div class="col-6 col-md-4">
            <label class="form-label">Skip (3–30s)</label>
            <input id="setting-skip" type="number" class="form-control" min="3" max="30" value="5">
          </div>
          <div class="col-6 col-md-4">
            <label class="form-label">Max Rounds (1–50)</label>
            <input id="setting-maxrounds" type="number" class="form-control" min="1" max="50" value="10">
          </div>
          <div class="col-12 col-md-6">
            <label class="form-label">Minigame Chance (0–100%)</label>
            <input id="setting-minigame" type="number" class="form-control" min="0" max="100" value="20">
          </div>
          <div class="col-12 col-md-6 form-check mt-4">
            <input id="setting-ai-generation" class="form-check-input" type="checkbox">
            <label class="form-check-label">Enable AI generation (Gemini 2.0 Flash-Lite)</label>
          </div>
        </div>

        <hr class="my-4">
        <div class="d-flex align-items-center justify-content-between">
          <div class="fw-semibold"><i class="bi bi-journal-text me-1"></i>Default Truths & Dares</div>
          <div class="d-flex gap-2">
            <button class="btn btn-outline-secondary btn-sm" id="btnDownloadPreset"><i class="bi bi-download me-1"></i>Save Preset</button>
            <label class="btn btn-outline-primary btn-sm mb-0">
              <i class="bi bi-upload me-1"></i>Load Preset
              <input id="presetFile" type="file" accept="application/json" hidden>
            </label>
          </div>
        </div>

        <div class="row g-3 mt-2">
          <div class="col-12 col-md-6">
            <div class="border rounded-3 p-2">
              <div class="d-flex align-items-center justify-content-between mb-2">
                <span class="fw-semibold">Truths</span>
                <button class="btn btn-outline-danger btn-sm" id="btnClearTruths">Clear</button>
              </div>
              <ul id="truth-list" class="list-group small"></ul>
              <div class="input-group input-group-sm mt-2">
                <input class="form-control" id="new-truth" placeholder="Add truth">
                <button class="btn btn-outline-success" id="btnAddTruth">Add</button>
              </div>
            </div>
          </div>
          <div class="col-12 col-md-6">
            <div class="border rounded-3 p-2">
              <div class="d-flex align-items-center justify-content-between mb-2">
                <span class="fw-semibold">Dares</span>
                <button class="btn btn-outline-danger btn-sm" id="btnClearDares">Clear</button>
              </div>
              <ul id="dare-list" class="list-group small"></ul>
              <div class="input-group input-group-sm mt-2">
                <input class="form-control" id="new-dare" placeholder="Add dare">
                <button class="btn btn-outline-success" id="btnAddDare">Add</button>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" id="btnSaveSettings"><i class="bi bi-save2 me-1"></i>Save</button>
        <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='room.js') }}"></script>
{% endblock %}
