<!doctype html>
<html lang="en" data-bs-theme="dark">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Room {{ room_code }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <script>
      (function () {
        const saved = localStorage.getItem('tod-theme');
        if (saved) document.documentElement.setAttribute('data-bs-theme', saved);
        else document.documentElement.setAttribute('data-bs-theme', 'dark');
      })();
    </script>
  </head>
  <body class="min-vh-100 d-flex flex-column">
    <nav class="navbar navbar-expand-lg border-bottom">
      <div class="container">
        <a class="navbar-brand fw-bold" href="/"><i class="bi bi-cup-hot me-2"></i>Truth or Dare</a>
        <div class="ms-auto d-flex gap-2">
          <span class="badge text-bg-primary">Room <span class="font-monospace">{{ room_code }}</span></span>
          <button id="theme-toggle" class="btn btn-outline-secondary btn-sm rounded-3">
            <i class="bi bi-moon-stars"></i>
          </button>
          <button id="leave-btn" class="btn btn-outline-danger btn-sm rounded-3">
            <i class="bi bi-box-arrow-left me-1"></i>Leave
          </button>
        </div>
      </div>
    </nav>

    <main class="container flex-fill py-4">
      <div class="row g-4">
        <!-- Left: Players -->
        <div class="col-lg-4">
          <div class="card h-100 rounded-4 shadow-sm">
            <div class="card-header d-flex justify-content-between align-items-center">
              <div class="fw-semibold"><i class="bi bi-people me-2"></i>Players</div>
              <span id="player-count" class="badge text-bg-secondary">0</span>
            </div>
            <div class="card-body">
              <ul id="player-list" class="list-group list-group-flush small"></ul>
              <div class="mt-3" id="host-controls" hidden>
                <div class="d-grid gap-2">
                  <button id="start-button" class="btn btn-primary rounded-3">
                    <i class="bi bi-play-circle me-2"></i>Start Game
                  </button>
                  <button id="restart-button" class="btn btn-warning rounded-3">
                    <i class="bi bi-arrow-counterclockwise me-2"></i>Restart
                  </button>
                  <button id="destroy-button" class="btn btn-outline-danger rounded-3">
                    <i class="bi bi-trash3 me-2"></i>Destroy Room
                  </button>
                </div>
                <div class="mt-3 d-grid">
                  <button class="btn btn-outline-secondary rounded-3" data-bs-toggle="modal" data-bs-target="#settingsModal">
                    <i class="bi bi-sliders me-2"></i>Settings
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Right: Game Area -->
        <div class="col-lg-8">
          <div class="card rounded-4 shadow-sm">
            <div class="card-body p-4">
              <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                <div>
                  <div class="fw-bold text-uppercase small text-secondary">Phase</div>
                  <div id="phase-label" class="fs-4">Lobby</div>
                </div>
                <div class="text-end">
                  <div class="fw-bold text-uppercase small text-secondary">Time Left</div>
                  <div id="timer" class="display-6 font-monospace">--</div>
                </div>
              </div>

              <hr>

              <div id="phase-panels">
                <!-- Lobby info -->
                <div id="panel-lobby" class="phase-panel">
                  <p class="text-secondary mb-0">Waiting for players. The host can start the game when ready.</p>
                </div>

                <!-- Preparation: submit truths/dares -->
                <div id="panel-preparation" class="phase-panel d-none">
                  <div class="row g-3">
                    <div class="col-md-6">
                      <label class="form-label">Submit new items</label>
                      <textarea id="submission-text" class="form-control" rows="4" placeholder="Write up to 3 lines; each line is one item"></textarea>
                      <div class="form-text">You’ll earn 10 points for each submission (max 3).</div>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Send to players</label>
                      <div id="player-checkboxes" class="row g-2"></div>
                      <div class="d-flex gap-2 mt-3">
                        <button id="submit-truth" class="btn btn-outline-info rounded-3 flex-fill"><i class="bi bi-chat-quote me-1"></i>Submit Truths</button>
                        <button id="submit-dare" class="btn btn-outline-danger rounded-3 flex-fill"><i class="bi bi-lightning-charge me-1"></i>Submit Dares</button>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Selection / Minigame -->
                <div id="panel-selection" class="phase-panel d-none">
                  <div class="alert alert-info rounded-3"><i class="bi bi-dice-5-fill me-2"></i>Picking a player or starting a minigame…</div>
                  <div class="d-grid">
                    <button id="minigame-vote" class="btn btn-outline-primary rounded-3"><i class="bi bi-controller me-2"></i>Participate</button>
                  </div>
                </div>

                <!-- Truth/Dare -->
                <div id="panel-truthdare" class="phase-panel d-none">
                  <div class="row g-3">
                    <div class="col-12">
                      <div id="selected-player" class="lead"></div>
                      <div class="d-flex gap-2 mt-2">
                        <button class="btn btn-outline-info rounded-3" id="choose-truth"><i class="bi bi-chat-quote me-2"></i>Truth</button>
                        <button class="btn btn-outline-danger rounded-3" id="choose-dare"><i class="bi bi-lightning-charge me-2"></i>Dare</button>
                        <button class="btn btn-outline-secondary rounded-3 ms-auto" id="vote-skip"><i class="bi bi-skip-forward me-2"></i>Vote Skip</button>
                      </div>
                    </div>
                    <div class="col-12">
                      <div id="current-prompt" class="fs-4 mt-3"></div>
                    </div>
                  </div>
                </div>

                <!-- End -->
                <div id="panel-end" class="phase-panel d-none">
                  <h5 class="mb-3">Game Over</h5>
                  <div id="scoreboard"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Settings Modal -->
    <div class="modal fade" id="settingsModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content rounded-4">
          <div class="modal-header">
            <h5 class="modal-title"><i class="bi bi-sliders me-2"></i>Game Settings</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="settings-form" class="row g-3">
              <div class="col-md-4">
                <label class="form-label">Countdown (3–30s)</label>
                <input type="number" class="form-control" id="setting-countdown" min="3" max="30" value="10">
              </div>
              <div class="col-md-4">
                <label class="form-label">Preparation (10–120s)</label>
                <input type="number" class="form-control" id="setting-preparation" min="10" max="120" value="30">
              </div>
              <div class="col-md-4">
                <label class="form-label">Selection (5–30s)</label>
                <input type="number" class="form-control" id="setting-selection" min="5" max="30" value="10">
              </div>
              <div class="col-md-4">
                <label class="form-label">Truth/Dare (30–180s)</label>
                <input type="number" class="form-control" id="setting-truthdare" min="30" max="180" value="60">
              </div>
              <div class="col-md-4">
                <label class="form-label">Skip (3–30s)</label>
                <input type="number" class="form-control" id="setting-skip" min="3" max="30" value="5">
              </div>
              <div class="col-md-4">
                <label class="form-label">Max Rounds (1–50)</label>
                <input type="number" class="form-control" id="setting-maxrounds" min="1" max="50" value="10">
              </div>
              <div class="col-md-6">
                <label class="form-label">Minigame chance (0–100%)</label>
                <input type="number" class="form-range w-100" id="setting-minigame" min="0" max="100" value="20">
              </div>
              <div class="col-md-6 d-flex align-items-end">
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="setting-ai-generation">
                  <label class="form-check-label" for="setting-ai-generation">Enable AI content generation</label>
                </div>
              </div>
            </form>

            <hr class="my-4" />

            <div class="row g-3 align-items-center">
              <div class="col-lg-6">
                <h6 class="mb-2">Default Truths & Dares</h6>
                <div class="d-flex flex-wrap gap-2">
                  <button id="add-default-truth" class="btn btn-outline-info btn-sm rounded-3"><i class="bi bi-plus-circle me-1"></i>Add Truth</button>
                  <button id="add-default-dare" class="btn btn-outline-danger btn-sm rounded-3"><i class="bi bi-plus-circle me-1"></i>Add Dare</button>
                  <button id="remove-default-truths" class="btn btn-outline-secondary btn-sm rounded-3"><i class="bi bi-x-circle me-1"></i>Clear Truths</button>
                  <button id="remove-default-dares" class="btn btn-outline-secondary btn-sm rounded-3"><i class="bi bi-x-circle me-1"></i>Clear Dares</button>
                </div>
              </div>
              <div class="col-lg-6">
                <h6 class="mb-2">Presets</h6>
                <div class="d-flex flex-wrap gap-2">
                  <button id="save-preset" class="btn btn-outline-success btn-sm rounded-3"><i class="bi bi-download me-1"></i>Save preset</button>
                  <label class="btn btn-outline-primary btn-sm rounded-3 mb-0">
                    <i class="bi bi-upload me-1"></i>Load preset
                    <input type="file" id="load-preset-file" accept="application/json" hidden>
                  </label>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button id="save-settings" class="btn btn-primary">Save</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Toasts -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
      <div id="mainToast" class="toast align-items-center" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
          <div class="toast-body" id="toast-body">Ready.</div>
          <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
      </div>
    </div>

    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js" crossorigin="anonymous"></script>
    <script>
      const ROOM_CODE = '{{ room_code }}';
      const PLAYER_NAME = '{{ name }}';
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/room.js') }}"></script>
  </body>
</html>
