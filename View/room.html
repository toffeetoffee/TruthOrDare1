<!doctype html>
<html lang="en" data-bs-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Room {{ room_code }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='room_styles.css') }}">
  </head>
  <body class="bg-body">
    <div class="container py-4">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
          <h1 class="h3 mb-0">Dare or Dare</h1>
          <div class="text-body-secondary small">Share the code with your friends!</div>
        </div>
        <div class="d-flex align-items-center gap-2">
          <div class="badge text-bg-primary fs-6 p-2">
            Room: <span class="fw-semibold">{{ room_code }}</span>
          </div>
          <button id="themeToggle" class="btn btn-outline-secondary btn-sm">üåû Light</button>
        </div>
      </div>

      <!-- Lobby Section -->
      <div id="lobby-section" class="lobby-section">
        <div class="row g-3">
          <div class="col-12 col-lg-7">
            <div class="card border-0 shadow-sm h-100">
              <div class="card-body">
                <h2 class="h5 mb-3">Players in Room</h2>
                <ul id="player-list" class="list-group mb-2">
                  <li class="list-group-item text-body-secondary">Waiting for players...</li>
                </ul>
                <div id="player-count" class="small text-body-secondary"></div>
              </div>
            </div>
          </div>
          <div class="col-12 col-lg-5">
            <div class="card border-0 shadow-sm h-100">
              <div class="card-body d-flex flex-column gap-3">
                <div class="d-flex gap-2">
                  <button class="btn btn-outline-secondary flex-fill" onclick="leaveRoom()">Leave Room</button>
                  <button id="openSettingsBtn" class="btn btn-outline-primary flex-fill" onclick="openSettings()">Settings</button>
                </div>
                <button id="start-button" class="btn btn-success w-100" onclick="startGame()">Start Game</button>
                <button class="btn btn-outline-danger w-100" onclick="destroyRoom()">Destroy Room</button>
                <div id="host-controls" class="visually-hidden"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Settings Modal (Bootstrap classes + existing IDs) -->
      <div id="settings-modal" class="modal fade" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Game Settings</h5>
              <button type="button" class="btn-close" aria-label="Close" onclick="closeSettings()" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <div class="alert alert-secondary small" role="alert">
                Save or load a preset file containing both truths and dares
                <div class="mt-2 d-flex gap-2">
                  <button class="btn btn-outline-secondary btn-sm" onclick="savePreset()">üíæ Save Preset</button>
                  <button class="btn btn-outline-secondary btn-sm" onclick="triggerLoadPreset()">üìÅ Load Preset</button>
                  <input type="file" id="load-preset-file" accept=".json" hidden onchange="loadPresetFile(event)">
                </div>
              </div>

              <ul class="nav nav-pills mb-3" role="tablist">
                <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#settings-tab-game" type="button">Game</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#settings-tab-truths" type="button">Default Truths</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#settings-tab-dares" type="button">Default Dares</button></li>
              </ul>

              <div class="tab-content">
                <div id="settings-tab-game" class="tab-pane fade show active">
                  <div class="row g-3">
                    <div class="col-12 col-sm-6 col-lg-4">
                      <label class="form-label">Countdown (s)</label>
                      <input type="number" id="setting-countdown" class="form-control" min="3" max="30" value="10">
                      <div class="form-text">3‚Äì30</div>
                    </div>
                    <div class="col-12 col-sm-6 col-lg-4">
                      <label class="form-label">Preparation (s)</label>
                      <input type="number" id="setting-preparation" class="form-control" min="10" max="120" value="30">
                      <div class="form-text">10‚Äì120</div>
                    </div>
                    <div class="col-12 col-sm-6 col-lg-4">
                      <label class="form-label">Selection (s)</label>
                      <input type="number" id="setting-selection" class="form-control" min="5" max="30" value="10">
                      <div class="form-text">5‚Äì30</div>
                    </div>
                    <div class="col-12 col-sm-6 col-lg-4">
                      <label class="form-label">Truth/Dare (s)</label>
                      <input type="number" id="setting-truthdare" class="form-control" min="30" max="180" value="60">
                      <div class="form-text">30‚Äì180</div>
                    </div>
                    <div class="col-12 col-sm-6 col-lg-4">
                      <label class="form-label">Skip (s)</label>
                      <input type="number" id="setting-skip" class="form-control" min="3" max="30" value="5">
                      <div class="form-text">3‚Äì30</div>
                    </div>
                    <div class="col-12 col-sm-6 col-lg-4">
                      <label class="form-label">Max Rounds</label>
                      <input type="number" id="setting-maxrounds" class="form-control" min="1" max="50" value="10">
                      <div class="form-text">1‚Äì50</div>
                    </div>
                    <div class="col-12 col-sm-6 col-lg-4">
                      <label class="form-label">Minigame Chance (%)</label>
                      <input type="number" id="setting-minigame" class="form-control" min="0" max="100" value="20">
                      <div class="form-text">0‚Äì100</div>
                    </div>
                    <div class="col-12">
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="setting-ai-generation" checked>
                        <label class="form-check-label" for="setting-ai-generation">AI-Powered Generation</label>
                      </div>
                      <div class="form-text">Auto-generate when a player runs out (requires Gemini API key)</div>
                    </div>
                  </div>
                </div>

                <div id="settings-tab-truths" class="tab-pane fade">
                  <div class="d-flex gap-2 mb-2">
                    <button class="btn btn-sm btn-outline-primary" onclick="addDefaultItem('truth')">+ Add Truth</button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="editDefaultItem('truth')">Edit Selected</button>
                    <button class="btn btn-sm btn-outline-danger" onclick="removeDefaultItems('truth')">Remove Selected</button>
                  </div>
                  <div class="default-list" id="default-truths-list"></div>
                  <div class="d-flex gap-2 mt-2">
                    <button class="btn btn-sm btn-outline-secondary" onclick="selectAllItems('truth')">Select All</button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="deselectAllItems('truth')">Deselect All</button>
                  </div>
                </div>

                <div id="settings-tab-dares" class="tab-pane fade">
                  <div class="d-flex gap-2 mb-2">
                    <button class="btn btn-sm btn-outline-primary" onclick="addDefaultItem('dare')">+ Add Dare</button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="editDefaultItem('dare')">Edit Selected</button>
                    <button class="btn btn-sm btn-outline-danger" onclick="removeDefaultItems('dare')">Remove Selected</button>
                  </div>
                  <div class="default-list" id="default-dares-list"></div>
                  <div class="d-flex gap-2 mt-2">
                    <button class="btn btn-sm btn-outline-secondary" onclick="selectAllItems('dare')">Select All</button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="deselectAllItems('dare')">Deselect All</button>
                  </div>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-primary" onclick="saveSettings()" data-bs-dismiss="modal">Save & Close</button>
              <button class="btn btn-secondary" onclick="closeSettings()" data-bs-dismiss="modal">Close</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Game Area -->
      <div id="game-area" class="game-area d-none">
        <div class="d-flex justify-content-end mb-2">
          <button class="btn btn-outline-secondary" onclick="leaveRoom()">Leave Room</button>
        </div>

        <!-- Countdown -->
        <div id="countdown-section" class="d-none">
          <div class="text-center py-4">
            <div class="lead">Game Starting In</div>
            <div id="countdown-timer" class="display-4 fw-bold">10</div>
          </div>
        </div>

        <!-- Preparation Phase -->
        <div id="preparation-section" class="d-none">
          <div class="card border-0 shadow-sm">
            <div class="card-body">
              <div class="mb-3 fw-semibold">
                Preparation Phase: <span id="prep-timer">30</span>s
              </div>
              <div class="row g-3 align-items-start">
                <div class="col-12 col-lg-8">
                  <textarea id="truth-dare-text" class="form-control mb-2" placeholder="Enter a truth question or dare challenge..."></textarea>
                  <div class="d-flex gap-2">
                    <select id="truth-dare-type" class="form-select w-auto">
                      <option value="truth">Truth</option>
                      <option value="dare">Dare</option>
                    </select>
                    <button class="btn btn-primary" onclick="submitTruthDare()">Submit</button>
                  </div>
                  <div id="submission-success" class="form-text mt-2 d-none"></div>
                </div>
                <div class="col-12 col-lg-4">
                  <div class="fw-medium mb-1">Add to players:</div>
                  <div id="player-checkboxes" class="player-checkboxes small text-body-secondary">
                    <div class="text-center">No other players yet</div>
                  </div>
                  <div class="d-flex gap-2 mt-2">
                    <button class="btn btn-sm btn-outline-secondary" onclick="selectAllPlayers()">Select All</button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="deselectAllPlayers()">Deselect All</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Selection Phase -->
        <div id="selection-section" class="d-none">
          <div class="card border-0 shadow-sm">
            <div class="card-body text-center">
              <div class="text-body-secondary mb-1">Selected Player</div>
              <div id="selected-player-name" class="h3">???</div>
              <div class="small text-body-secondary mb-3">
                Time remaining: <span id="selection-timer">10</span>s
              </div>
              <div id="truth-dare-choice" class="d-flex gap-2 justify-content-center d-none">
                <button class="btn btn-outline-primary" onclick="selectTruthDare('truth')">Truth</button>
                <button class="btn btn-outline-danger" onclick="selectTruthDare('dare')">Dare</button>
              </div>
              <div id="choice-made" class="mt-3 text-body-secondary d-none">
                Choice: <span id="choice-display"></span>
              </div>
            </div>
          </div>
        </div>

        <!-- Minigame Phase -->
        <div id="minigame-section" class="d-none">
          <div class="card border-0 shadow-sm">
            <div class="card-body">
              <div class="h5 minigame-title">üéÆ Staring Contest</div>
              <div class="mb-3 minigame-description">Who will blink first?</div>

              <div class="d-flex align-items-center justify-content-center gap-3 my-3">
                <div class="text-center">
                  <div id="participant-1" class="h6 mb-1">Player 1</div>
                  <div id="participant-1-votes" class="small text-body-secondary">0 votes</div>
                </div>
                <div class="h6 text-body-secondary">VS</div>
                <div class="text-center">
                  <div id="participant-2" class="h6 mb-1">Player 2</div>
                  <div id="participant-2-votes" class="small text-body-secondary">0 votes</div>
                </div>
              </div>

              <div id="minigame-voting" class="text-center d-none">
                <div class="voting-instruction mb-2">Vote for the loser!</div>
                <div class="d-flex justify-content-center gap-2">
                  <button class="btn btn-outline-secondary" id="vote-btn-1" onclick="voteMinigame(null)">
                    <span id="vote-name-1">Player 1</span> lose!
                  </button>
                  <button class="btn btn-outline-secondary" id="vote-btn-2" onclick="voteMinigame(null)">
                    <span id="vote-name-2">Player 2</span> lose!
                  </button>
                </div>
                <div class="small text-body-secondary mt-2">
                  Votes: <span id="minigame-vote-count">0</span> / <span id="minigame-required-votes">?</span>
                </div>
              </div>

              <div id="minigame-participant-message" class="alert alert-info d-none mt-3">
                <p class="mb-1">You are competing!</p>
                <p class="mb-0">Other players will vote for who lose!</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Truth/Dare Phase -->
        <div id="truth-dare-section" class="d-none">
          <div class="card border-0 shadow-sm">
            <div class="card-body">
              <div id="empty-list-banner" class="alert alert-warning d-none">
                <strong>List Empty!</strong> The selected player has run out of available challenges. Skip has been automatically activated.
              </div>
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div id="phase-type" class="badge text-bg-danger">DARE</div>
                <div class="small">
                  <span id="performing-player-name" class="fw-semibold">Alice</span> is performing
                </div>
              </div>
              <div id="challenge-text" class="p-3 rounded-3 border bg-body-tertiary">
                Do 10 pushups
              </div>
              <div class="mt-2 small text-body-secondary">
                Time: <span id="truth-dare-timer">60</span>s
              </div>

              <div id="vote-section" class="mt-3 d-none text-center">
                <button id="vote-skip-button" class="btn btn-outline-secondary" onclick="voteSkip()">Vote to Skip</button>
                <div class="small text-body-secondary mt-1">
                  <span id="vote-count">0</span> / <span id="required-votes">?</span> votes to skip
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- End Game -->
        <div id="end-game-section" class="d-none">
          <div class="card border-0 shadow-sm">
            <div class="card-body">
              <div class="h4 mb-3">üéâ Game Over! üéâ</div>
              <div class="row g-4">
                <div class="col-12 col-lg-6">
                  <div class="border rounded-3 p-3 h-100">
                    <div class="fw-semibold mb-2">Top Players</div>
                    <div id="top-players-list"></div>
                  </div>
                </div>
                <div class="col-12 col-lg-6">
                  <div class="border rounded-3 p-3 h-100">
                    <div class="fw-semibold mb-2">Round History</div>
                    <div id="round-history-list"></div>
                  </div>
                </div>
              </div>
              <div id="end-game-host-controls" class="d-none mt-3">
                <div class="d-flex gap-2">
                  <button class="btn btn-outline-primary" onclick="openSettings()">Settings</button>
                  <button class="btn btn-success" onclick="restartGame()">Restart Game</button>
                </div>
              </div>
              <div class="mt-3 text-end">
                <button class="btn btn-outline-secondary" onclick="leaveRoom()">Leave Room</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="toast-container" class="toast-container position-fixed bottom-0 end-0 p-3"></div>

    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js" crossorigin="anonymous"></script>
    <script>
      const ROOM_CODE = '{{ room_code }}';
      const PLAYER_NAME = '{{ name }}';
    </script>
    <script src="{{ url_for('static', filename='room_script.js') }}"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
