<!doctype html>
<html lang="en" data-bs-theme="dark">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Truth or Dare â€“ Room {{ room_code }}</title>

    <!-- Bootstrap 5 -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- Custom -->
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='room_styles.css') }}"
    />
  </head>

  <body class="bg-body text-body">
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg border-bottom bg-body px-3">
      <span class="navbar-brand fw-semibold">ðŸŽ² Truth or Dare</span>

      <div class="ms-auto d-flex align-items-center gap-2">
        <button
          id="theme-toggle"
          type="button"
          class="btn btn-outline-light btn-sm d-flex align-items-center gap-2"
        >
          <span class="td-theme-label">Light mode</span>
        </button>

        <button type="button" class="btn btn-outline-danger btn-sm" onclick="leaveRoom()">
          Leave
        </button>
      </div>
    </nav>

    <main class="container-fluid py-3">
      <div class="row g-3">
        <!-- LEFT COLUMN ===================================================== -->
        <div class="col-lg-4" id="left-column">
          <!-- Lobby Section -->
          <section id="lobby-section" class="lobby-section">
            <!-- Room Details -->
            <div class="card mb-3 shadow-sm">
              <div class="card-body">
                <h5 class="card-title mb-1">Room Details</h5>
                <p class="small text-secondary">Share this code with others to join.</p>

                <div class="d-flex justify-content-between">
                  <span class="small text-secondary">Room code</span>
                  <span class="badge bg-primary-subtle text-primary-emphasis fs-6 px-3 py-2">
                    {{ room_code }}
                  </span>
                </div>
              </div>
            </div>

            <!-- Player List -->
            <div class="card mb-3 shadow-sm">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                  <h5 class="card-title mb-0">Players</h5>
                  <span class="badge bg-secondary-subtle text-secondary-emphasis">
                    <span id="player-count">0</span>
                  </span>
                </div>

                <ul id="player-list" class="list-group list-group-flush mt-3 small"></ul>
              </div>
            </div>

            <!-- Host Controls -->
            <div id="host-controls" class="host-controls">
              <div class="card shadow-sm">
                <div class="card-body">
                  <h6 class="fw-semibold mb-2">
                    Host Controls <span class="badge bg-warning-subtle text-warning-emphasis">Host</span>
                  </h6>

                  <div class="d-grid gap-2 mb-3">
                    <button id="start-button" class="btn btn-primary btn-sm" onclick="startGame()">
                      Start Game
                    </button>

                    <button class="btn btn-outline-secondary btn-sm" onclick="openSettings()">
                      Game Settings
                    </button>

                    <button class="btn btn-outline-warning btn-sm" onclick="restartGame()">
                      Restart Game
                    </button>

                    <button class="btn btn-outline-danger btn-sm" onclick="destroyRoom()">
                      Destroy Room
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </section>
        </div>

        <!-- GAME AREA ======================================================== -->
        <div class="col-lg-8">
          <section id="game-area" class="game-area">
            <!-- PHASE HEADER -->
            <div class="card shadow-sm mb-3">
              <div class="card-body d-flex flex-wrap align-items-center gap-3">
                <div>
                  <div class="small text-secondary mb-1">Current Phase</div>
                  <div
                    id="phase-type"
                    class="badge rounded-pill bg-info-subtle text-info-emphasis px-3 py-2"
                  >
                    Lobby
                  </div>
                </div>

                <div class="ms-auto small text-secondary">
                  Time left: <span id="countdown-timer" class="fw-semibold">0</span>s
                </div>

                <div
                  id="empty-list-banner"
                  class="alert alert-warning py-1 px-3 mb-0 d-none"
                >
                  No more items. AI or skip may activate.
                </div>
              </div>
            </div>

            <!-- COUNTDOWN PHASE -->
            <section id="countdown-section" class="phase-section mb-3" style="display:none;">
              <div class="card shadow-sm">
                <div class="card-body text-center">
                  <h3 class="h5 mb-2">Next round startingâ€¦</h3>
                  <p class="text-secondary small mb-3">Get ready!</p>
                  <div id="big-countdown-timer" class="display-1 fw-bold">10</div>
                </div>
              </div>
            </section>

            <!-- PREPARATION PHASE -->
            <section id="preparation-section" class="phase-section mb-3" style="display:none;">
              <div class="card shadow-sm">
                <div class="card-body">
                  <div class="d-flex justify-content-between">
                    <h5 class="mb-2">Preparation</h5>
                    <span class="badge bg-secondary-subtle text-secondary-emphasis">
                      <span id="prep-timer">30</span>s
                    </span>
                  </div>

                  <p class="small text-secondary">
                    Add truths or dares for other players.
                  </p>

                  <div
                    id="submission-success"
                    class="alert alert-success py-2 px-3 small mb-3"
                    style="display:none;"
                  ></div>

                  <div class="row g-3">
                    <!-- Left -->
                    <div class="col-md-7">
                      <label class="form-label">Type</label>
                      <select id="truth-dare-type" class="form-select form-select-sm mb-2">
                        <option value="truth">Truth</option>
                        <option value="dare">Dare</option>
                      </select>

                      <label class="form-label">Your prompt</label>
                      <textarea
                        id="truth-dare-text"
                        class="form-control mb-2"
                        rows="3"
                      ></textarea>

                      <button class="btn btn-success btn-sm" onclick="submitTruthDare()">Submit</button>
                    </div>

                    <!-- Right -->
                    <div class="col-md-5">
                      <div class="d-flex justify-content-between mb-2">
                        <label class="form-label mb-0 small">Target players</label>
                        <div class="small">
                          <button class="btn btn-link btn-sm p-0" onclick="selectAllPlayers()"
                            >Select all</button
                          >
                          <button class="btn btn-link btn-sm p-0" onclick="deselectAllPlayers()"
                            >Clear</button
                          >
                        </div>
                      </div>

                      <div id="player-checkboxes" class="player-checkbox-list small"></div>
                    </div>
                  </div>
                </div>
              </div>
            </section>

            <!-- SELECTION PHASE -->
            <section id="selection-section" class="phase-section mb-3" style="display:none;">
              <div class="card shadow-sm">
                <div class="card-body text-center">
                  <h5 class="mb-2">Selecting a playerâ€¦</h5>
                  <div id="selected-player-name" class="display-6 mb-1">?</div>
                  <div class="small text-secondary">
                    Time left: <span id="selection-timer" class="fw-semibold">10</span>s
                  </div>
                </div>
              </div>
            </section>

            <!-- MINIGAME PHASE -->
            <section id="minigame-section" class="phase-section mb-3" style="display:none;">
              <div class="card shadow-sm">
                <div class="card-body">
                  <h3 id="minigame-title" class="h5 mb-2">Mini Game</h3>
                  <p id="minigame-description" class="small text-secondary"></p>

                  <div id="minigame-participant-message" style="display:none;">
                    <p></p>
                  </div>

                  <p id="voting-instruction" class="fw-semibold"></p>

                  <div id="minigame-voting" class="row g-3 mt-2">
                    <div class="col-md-5 text-center">
                      <div class="border rounded-3 p-2">
                        <div id="participant-1" class="fw-semibold mb-1">Player 1</div>
                        <button id="vote-btn-1" class="btn btn-outline-success btn-sm">Vote</button>
                        <div class="small text-secondary">
                          Votes: <span id="participant-1-votes">0</span>
                        </div>
                      </div>
                    </div>

                    <div class="col-md-5 text-center">
                      <div class="border rounded-3 p-2">
                        <div id="participant-2" class="fw-semibold mb-1">Player 2</div>
                        <button id="vote-btn-2" class="btn btn-outline-success btn-sm">Vote</button>
                        <div class="small text-secondary">
                          Votes: <span id="participant-2-votes">0</span>
                        </div>
                      </div>
                    </div>

                    <div class="col-md-2 text-center small text-secondary">
                      Total: <span id="minigame-vote-count">0</span><br />
                      Needed: <span id="minigame-required-votes">0</span>
                    </div>
                  </div>
                </div>
              </div>
            </section>

            <!-- TRUTH/DARE PHASE -->
            <section id="truth-dare-section" class="phase-section mb-3" style="display:none;">
              <div class="card shadow-sm">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <div class="small text-secondary">Performing player</div>
                      <div id="performing-player-name" class="fw-semibold">?</div>
                    </div>

                    <div class="small text-secondary">
                      Time left: <span id="truth-dare-timer" class="fw-semibold">60</span>s
                    </div>
                  </div>

                  <div
                    id="challenge-text"
                    class="border rounded-3 p-3 bg-body-secondary mt-3 mb-3"
                  >
                    Waiting for challengeâ€¦
                  </div>

                  <div id="truth-dare-choice" class="d-flex gap-2 mb-3" style="display:none;">
                    <button class="btn btn-outline-info" onclick="selectTruthDare('truth')">Truth</button>
                    <button class="btn btn-outline-danger" onclick="selectTruthDare('dare')">Dare</button>
                  </div>

                  <div id="choice-display" class="small text-secondary"></div>
                  <div id="choice-made" class="small fw-semibold" style="display:none;"></div>

                  <div id="vote-section" class="vote-section mt-3" style="display:none;">
                    <button
                      id="vote-skip-button"
                      class="btn btn-outline-warning btn-sm mb-2"
                      onclick="voteSkip()"
                    >
                      Vote to Skip
                    </button>
                    <div class="small text-secondary">
                      <span id="vote-count">0</span> /
                      <span id="required-votes">0</span> votes required
                    </div>
                  </div>
                </div>
              </div>
            </section>

            <!-- END GAME -->
            <section id="end-game-section" class="phase-section" style="display:none;">
              <div class="card shadow-sm mb-3">
                <div class="card-body">
                  <h3 class="text-center">ðŸŽ‰ Game Over ðŸŽ‰</h3>

                  <div class="row g-3 mt-3">
                    <div class="col-md-5">
                      <h6>Top Players</h6>
                      <div id="top-players-list"></div>
                    </div>

                    <div class="col-md-7">
                      <h6>Round History</h6>
                      <div id="round-history-list" class="round-history-list"></div>
                    </div>
                  </div>
                </div>
              </div>

              <div id="end-game-host-controls" style="display:none;">
                <div class="card shadow-sm">
                  <div class="card-body d-flex flex-wrap justify-content-between">
                    <div class="small text-secondary">Host Options</div>
                    <div class="d-flex gap-2">
                      <button class="btn btn-outline-secondary btn-sm" onclick="restartGame()">
                        Restart
                      </button>
                      <button class="btn btn-outline-danger btn-sm" onclick="destroyRoom()">
                        Close Room
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </section>
          </section>
        </div>
      </div>
    </main>

    <!-- SETTINGS MODAL (custom, NOT Bootstrap modal.js) -->
    <div id="settings-modal" class="td-settings-modal">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content bg-body">
          <div class="modal-header">
            <h5 class="modal-title">Game Settings</h5>
            <button class="btn-close" onclick="closeSettings()"></button>
          </div>

          <div class="modal-body">
            <!-- Tabs -->
            <ul class="nav nav-pills mb-3 small">
              <li class="nav-item">
                <button class="nav-link settings-tab active" onclick="showSettingsTab('game')">
                  Gameplay
                </button>
              </li>
              <li class="nav-item">
                <button class="nav-link settings-tab" onclick="showSettingsTab('truths')">
                  Truths
                </button>
              </li>
              <li class="nav-item">
                <button class="nav-link settings-tab" onclick="showSettingsTab('dares')">
                  Dares / Presets
                </button>
              </li>
            </ul>

            <!-- GAME TAB -->
            <div id="settings-tab-game" class="settings-tab-content active">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">Countdown (3â€“30)</label>
                  <input id="setting-countdown" type="number" class="form-control" />
                </div>

                <div class="col-md-6">
                  <label class="form-label">Preparation (10â€“120)</label>
                  <input id="setting-preparation" type="number" class="form-control" />
                </div>

                <div class="col-md-6">
                  <label class="form-label">Selection (5â€“30)</label>
                  <input id="setting-selection" type="number" class="form-control" />
                </div>

                <div class="col-md-6">
                  <label class="form-label">Truth/Dare (30â€“180)</label>
                  <input id="setting-truthdare" type="number" class="form-control" />
                </div>

                <div class="col-md-6">
                  <label class="form-label">Skip Duration (3â€“30)</label>
                  <input id="setting-skip" type="number" class="form-control" />
                </div>

                <div class="col-md-6">
                  <label class="form-label">Max Rounds (1â€“50)</label>
                  <input id="setting-maxrounds" type="number" class="form-control" />
                </div>

                <div class="col-md-6">
                  <label class="form-label">Minigame Chance (%)</label>
                  <input id="setting-minigame" type="number" class="form-control" />
                </div>

                <div class="col-md-6">
                  <label class="form-label">AI Generation</label>
                  <input id="setting-ai-generation" type="checkbox" />
                </div>
              </div>
            </div>

            <!-- TRUTHS TAB -->
            <div id="settings-tab-truths" class="settings-tab-content">
              <h6>Default Truths</h6>
              <div id="default-truths-list" class="default-list"></div>

              <div class="d-flex gap-2 mt-2">
                <button class="btn btn-outline-success btn-sm" onclick="addDefaultItem('truth')">
                  Add
                </button>
                <button class="btn btn-outline-primary btn-sm" onclick="editDefaultItem('truth')">
                  Edit
                </button>
                <button class="btn btn-outline-danger btn-sm" onclick="removeDefaultItems('truth')">
                  Remove
                </button>
              </div>
            </div>

            <!-- DARES TAB -->
            <div id="settings-tab-dares" class="settings-tab-content">
              <h6>Default Dares</hh6>
              <div id="default-dares-list" class="default-list"></div>

              <div class="d-flex gap-2 mt-2">
                <button class="btn btn-outline-success btn-sm" onclick="addDefaultItem('dare')">
                  Add
                </button>
                <button class="btn btn-outline-primary btn-sm" onclick="editDefaultItem('dare')">
                  Edit
                </button>
                <button class="btn btn-outline-danger btn-sm" onclick="removeDefaultItems('dare')">
                  Remove
                </button>
              </div>

              <hr />

              <button class="btn btn-outline-primary btn-sm" onclick="triggerLoadPreset()">
                Load presetâ€¦
              </button>

              <button class="btn btn-outline-success btn-sm" onclick="savePreset()">
                Export preset
              </button>

              <input
                id="load-preset-file"
                type="file"
                class="d-none"
                accept="application/json"
                onchange="loadPresetFile(event)"
              />
            </div>
          </div>

          <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeSettings()">Close</button>
            <button class="btn btn-primary" onclick="saveSettings()">Save</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Socket.io -->
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <script src="{{ url_for('static', filename='room_script.js') }}"></script>

    <!-- Bootstrap Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Theme Toggle -->
    <script>
      (function () {
        const stored = localStorage.getItem("td-theme");
        const prefersDark =
          window.matchMedia &&
          window.matchMedia("(prefers-color-scheme: dark)").matches;

        const initial = stored || (prefersDark ? "dark" : "dark");
        document.documentElement.setAttribute("data-bs-theme", initial);

        function updateToggle(mode) {
          const btn = document.getElementById("theme-toggle");
          const label = btn.querySelector(".td-theme-label");
          label.textContent = mode === "dark" ? "Light mode" : "Dark mode";
        }

        document.addEventListener("DOMContentLoaded", function () {
          updateToggle(initial);
          const btn = document.getElementById("theme-toggle");
          btn.addEventListener("click", function () {
            const current =
              document.documentElement.getAttribute("data-bs-theme") || "dark";
            const next = current === "dark" ? "light" : "dark";
            document.documentElement.setAttribute("data-bs-theme", next);
            localStorage.setItem("td-theme", next);
            updateToggle(next);
          });
        });
      })();
    </script>
  </body>
</html>
